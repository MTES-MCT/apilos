{% load custom_filters %}

<div class="fr-container">
    <div class="fr-grid-row fr-grid-row--gutters">
        <div class="fr-col-md-12 ">

            <form class="fr-my-3w" method="get" action="" id="search_table">
                <input type="hidden" id="order_by" name="order_by" value="{{conventions.order_by}}">
                <input type="hidden" id="page" name="page" value="{{conventions.page}}">
                <div class="fr-grid-row fr-grid-row--gutters">
                    <div class="fr-col-12 fr-col-md-12 fr-col-lg-5 fr-mb-2w">
                        <input class="fr-input" placeholder="par nom, code d’opération ou ville" type="search" id="search_input" name="search_input" value="{{conventions.search_input}}">
                    </div>
                    <div class="fr-col-12 fr-col-md-12 fr-col-lg-3 fr-mb-2w">
                        <div class="fr-select-group">
                            <select class="fr-select" id="cstatut" name="cstatut">
                                <option value="">Statut</option>
                                {% for statut in statuts %}
                                    <option value="{{statut.value}}"
                                        {% if statut.value  == conventions.statut_filter %}selected{% endif %}>
                                        {{statut.label}}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="fr-col-12 fr-col-md-12 fr-col-lg-3 fr-mb-2w">
                        <div class="fr-select-group">

                            <select class="fr-select" name="financement">
                                <option value="">Financement</option>
                                {% for financement in financements %}
                                    <option value="{{financement.value}}"
                                        {% if financement.value  == conventions.financement_filter %}selected{% endif %}>
                                        {{financement.label}}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="fr-col-1 fr-grid-row fr-grid-row--right">
                        <button class="fr-btn fr-fi-search-line" title="Rechercher" id="search_btn">
                        </button>
                    </div>
                </div>
                {% if request.user.is_staff %}
                    <div class="apilos-bordered fr-my-3w fr-col-12 fr-col-md-12 fr-col-lg-11">
                        <p class="notes">
                            <em>Les paramètres de recherche dans cet encadré sont disponibles uniquement pour les utilisateurs avancés.</em>
                        </p>
                        <div class="fr-grid-row fr-grid-row--gutters">
                            <div class="fr-col-12 fr-col-md-12 fr-col-lg-3 fr-mb-2w">
                                <label class="fr-label" for="search_input">
                                    Préciser un département
                                </label>
                                <input class="fr-input" placeholder="Ex : 13" type="recherche" name="departement_input" value="{{conventions.departement_input}}">
                            </div>
                        </div>
                    </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>
<div class="fr-container-fluid ds_banner">
    <div class="fr-container fr-py-3w">
        <div class="fr-grid-row fr-grid-row--gutters fr-card fr-card--no-border">
            <div class="fr-col-md-12">
                <details class="fr-py-2w apilos-order-menu">
                    <summary class="fr-grid-row fr-grid-row--right">Trier par  <span class="apilos-order-name fr-link"></span><span class="fr-icon-arrow-down-s-line"></span></summary>
                    <div class="fr-grid-row fr-grid-row--right">
                        <div class="apilos-order-menu--open fr-p-2w">
                            {% if request|is_instructeur %}
                                <div  class="fr-py-1w">
                                    {% include "common/table/display_order_item.html" with order_by=conventions.order_by order_by_column='bailleur__nom' url_target='conventions:index' label_order='Bailleur' %}
                                </div>
                            {% endif %}
                            {% if request|display_administration %}
                                <div  class="fr-py-1w">
                                    {% include "common/table/display_order_item.html" with order_by=conventions.order_by order_by_column='programme__administration__nom' url_target='conventions:index' label_order='Instructeur' %}
                                </div>
                            {% endif %}
                            <div  class="fr-py-1w">
                                {% include "common/table/display_order_item.html" with order_by=conventions.order_by order_by_column='programme__nom' url_target='conventions:index' label_order='Nom du programme' %}
                            </div>
                            <div class="fr-py-1w">
                                {% include "common/table/display_order_item.html" with order_by=conventions.order_by order_by_column='lot__financement' url_target='conventions:index' label_order='Financement'%}
                            </div>
                            <div class="fr-py-1w">
                                {% include "common/table/display_order_item.html" with order_by=conventions.order_by order_by_column='programme__ville' url_target='conventions:index' label_order='Ville' %}
                            </div>
                            <div class="fr-py-1w">
                                {% include "common/table/display_order_item.html" with order_by=conventions.order_by order_by_column='programme__code_postal' url_target='conventions:index' label_order='Code postal' %}
                            </div>
                            <div class="fr-py-1w">
                                {% include "common/table/display_order_item.html" with order_by=conventions.order_by order_by_column='lot__nb_logements' url_target='conventions:index' label_order='Nombre de logements' %}
                            </div>
                            <div class="fr-py-1w">
                                {% include "common/table/display_order_item.html" with order_by=conventions.order_by order_by_column='programme__date_achevement_compile' url_target='conventions:index' label_order='Date de réalisation' %}
                            </div>
                        </div>
                    </div>
                </details>
                {% if conventions.paginated_conventions %}
                    <div class="fr-table fr-table--bordered table--layout-fixed">
                        <table>
                            {% if conventions.paginated_conventions.paginator.count != conventions.total_conventions %}
                                <caption><em>{{ conventions.paginated_conventions.paginator.count }} convention{{ conventions.paginated_conventions.paginator.count|pluralize }} correspondent à votre recherche</em></caption>
                            {% endif %}
                            <thead>
                                <tr class="th_inline">
                                    <th title="Statut de la convention" scope="col">
                                        Statut
                                    </th>
                                    {% if request|is_instructeur %}
                                        <th scope="col">Bailleur</th>
                                    {% endif %}
                                    {% if request|display_administration %}
                                        <th scope="col">Instructeur</th>
                                    {% endif %}
                                    <th title="Opération" scope="col">
                                        Opération
                                    </th>
                                    <th title="Financement" scope="col">
                                        Financement
                                    </th>
                                    <th title="Ville" scope="col">
                                        Ville
                                    </th>
                                    <th title="Nombre de logements à conventionner" scope="col">
                                        Logements
                                    </th>
                                    <th title="Date de livraison et mise en service" scope="col">
                                        Livraison
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for convention in conventions.paginated_conventions %}

                                    <tr id="convention_redirect_{{convention.uuid}}" class="clickable {% if convention.display_options.display_redirect_sent %}sent{% elif convention.display_options.display_redirect_post_action %}signed{% endif %}">
                                        <td title="{{convention.statut_for_template.statut_display}}">
                                            <span class="fr-p-1w apilos-colored_status apilos-colored_status--{{convention.statut_for_template.key_statut}}">
                                                <strong>
                                                    {{convention.short_statut_for_template}}
                                                </strong>
                                            </span>
                                            <script type="text/javascript" nonce="{{request.csp_nonce}}">
                                                document.addEventListener('DOMContentLoaded', function () {
                                                    document.getElementById('convention_redirect_{{convention.uuid}}').addEventListener('click', function(){
                                                        if (this.classList.contains("sent")) {
                                                            location.href="{% url 'conventions:sent' convention_uuid=convention.uuid %}"
                                                        }
                                                        else if (this.classList.contains("signed")) {
                                                            location.href="{% url 'conventions:post_action' convention_uuid=convention.uuid %}"
                                                        }
                                                        else {
                                                            location.href="{% url 'conventions:recapitulatif' convention_uuid=convention.uuid %}"
                                                        }
                                                    });
                                                });
                                            </script>
                                        </td>
                                        {% if request|is_instructeur %}
                                            <td>{{convention.bailleur}}</td>
                                        {% endif %}
                                        {% if request|display_administration %}
                                            <td>{{convention.programme.administration}}</td>
                                        {% endif %}
                                        <td>
                                            <strong>{{convention.programme.nom}}</strong><br/>
                                            <em>{{convention.programme.numero_galion}}</em>
                                        </td>
                                        <td>{{convention.financement}}</td>
                                        <td>
                                            <strong>{{convention.programme.ville}}</strong><br/>
                                            <em>{{convention.programme.code_postal}}</em>
                                        </td>
                                        <td>{{convention.lot.nb_logements}}</td>
                                        <td>{{convention.programme.date_achevement_compile|date:"d F Y"|default_if_none:'-' }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% include 'common/table/pagination.html' with paginate_list=conventions.paginated_conventions %}

                {% else %}
                    <p>Aucune convention ne correspond à votre recherche...</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>


