<div class="fr-container">
    <div class="fr-grid-row fr-grid-row--gutters">
        <div class="fr-col-12 fr-grid-row fr-grid-row--right">
            <a href="{% url 'conventions:loyer_simulateur' %}" class="fr-link fr-ml-2w"
               title="Calculatrice de loyers"
               aria-selected="{% if request.resolver_match.view_name == "conventions:loyer_simulateur" %}true{% else %}false{% endif %}"                                >
                <span aria-hidden="true" class="fr-icon-equalizer-fill"></span>
                Calculatrice de loyers
            </a>
        </div>

        <div class="fr-col-md-12 fr-mb-1w">
            <hr>
            <form class="fr-mt-2w" method="get" action="" id="search_table">
                <input type="hidden" id="order_by" name="order_by" value="{{ order_by }}">
                <input type="hidden" id="page" name="page" value="{{ page }}">

                <div class="fr-grid-row fr-grid-row--gutters fr-mb-1w">

                    {# Champs nom de l'opération #}
                    <div class="fr-col-12 fr-col-lg-6 search-input">
                        <label class="select-label" for="search_operation_nom">Nom de l'opération</label>
                        <input class="fr-input fr-mt-1w" type="search" id="search_operation_nom" name="search_operation_nom" value="{{ request.GET.search_operation_nom }}" placeholder="Rechercher"/>
                    </div>

                    {# Champs numéro de l'opération ou de la convention #}
                    <div class="fr-col-12 fr-col-lg-6 search-input">
                        <label class="select-label" for="search_numero">Numéro de l'opération ou de la convention</label>
                        <input class="fr-input fr-mt-1w" type="search" id="search_numero" name="search_numero" value="{{ request.GET.search_numero }}" placeholder="Rechercher"/>
                    </div>

                </div>

                <div class="fr-grid-row fr-grid-row--gutters fr-mb-1w">

                    {# Champs bailleur #}
                    {% if bailleur_query %}
                        <div class="fr-col-12 fr-col-md-12 fr-col-lg-6 search-select search-bailleur">
                            {% url 'users:search_bailleur' as search_bailleur_url %}
                            {% if request.GET.bailleur %}
                                {% bailleur_from request.GET.bailleur as bailleur_initial %}
                            {% endif %}
                            {% include "common/form/input_search_select_unified.html" with field_id="search-field-bailleur" field_name="bailleur" label="Bailleur (nom ou SIREN)" placeholder="Rechercher" search_url=search_bailleur_url initial_value=request.GET.bailleur initial_text=bailleur_initial initial_queryset=bailleur_query %}
                        </div>
                    {% endif %}


                    {# Champs commune #}
                    <div class="fr-col-12 fr-col-lg-6 search-input">
                        <label class="select-label" for="search_lieu">Commune, code postal</label>
                        <input class="fr-input fr-mt-1w" type="search" id="search_lieu" name="search_lieu" value="{{ request.GET.search_lieu }}" placeholder="Rechercher"/>
                    </div>

                </div>

                <div class="fr-grid-row fr-grid-row--gutters fr-mb-2w">

                    {% include "common/form/input_multiselect_choices.html" with field_id="cstatut" label="Statut convention ou avenant" request="request.GET.cstatut" choices="statut_choices" %}

                    {% comment %} {# Champs statut #}
                    <div class="fr-col-12 fr-col-lg-3 search-select search-statut">
                        <label class="select-label" for="cstatut" id="label-cstatut">
                            Statut convention ou avenant
                        </label>
                        <select
                            multiple
                            class="fr-select fr-mt-1w"
                            id="cstatut"
                            name="cstatut"
                            aria-labelledby="label-cstatut">
                            {% for label, value in statut_choices %}
                                <option value="{{ value }}"
                                        {% if value in request.GET.cstatut %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <script type="text/javascript" nonce="{{ request.csp_nonce }}">
                        document.addEventListener('DOMContentLoaded', function() {
                            const element = document.querySelector('#cstatut');

                            if (element) {
                                const choices = new Choices(element, {
                                    removeItemButton: true,
                                    searchEnabled: false,
                                    placeholder: true,
                                    placeholderValue: 'Sélectionner',
                                    itemSelectText: '',
                                    shouldSort: false,
                                    classNames: {
                                        containerOuter: ['choices', 'fr-select', 'fr-mt-1w']
                                    },
                                    noResultsText: 'Aucun résultat',
                                    noChoicesText: 'Aucun choix disponible',
                                    removeItemIconText: 'Supprimer',
                                    removeItemLabelText: 'Supprimer l\'élément',
                                    labelId: 'label-cstatut'
                                });

                                // Associer le label au champ de recherche
                                const choicesInput = element.closest('.choices').querySelector('.choices__input');
                                if (choicesInput) {
                                    choicesInput.setAttribute('aria-labelledby', 'label-cstatut');
                                }

                                // Labels explicites pour les boutons de suppression
                                choices.passedElement.element.addEventListener('addItem', function() {
                                    setTimeout(() => {
                                        const items = element.closest('.choices').querySelectorAll('.choices__item--selectable');
                                        items.forEach(item => {
                                            const button = item.querySelector('.choices__button');
                                            if (button) {
                                                const itemText = item.textContent.replace('Supprimer l\'élément', '').trim();
                                                button.setAttribute('aria-label', `Supprimer ${itemText}`);
                                            }
                                        });
                                    }, 10);
                                });
                            }
                        });
                    </script> {% endcomment %}

                    {# Champs financement #}
                    <div class="fr-col-12 fr-col-lg-3 search-select">
                        <label class="select-label" for="financement">Type de financement</label>
                        <select class="fr-select fr-mt-1w" name="financement" id="financement">
                            <option value="">Sélectionner une option</option>
                            {% for value, label in financement_choices %}
                                <option value="{{ value }}"
                                        {% if value == request.GET.financement %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    {# Champs date de signature #}
                    {% if date_signature_choices %}
                        <div class="fr-col-12 fr-col-lg-3 search-select">
                            <label class="select-label" for="date_signature">Année de signature</label>
                            <select class="fr-select fr-mt-1w" name="date_signature" id="date_signature">
                                <option value="">Sélectionner une période</option>
                                {% for value, label in date_signature_choices %}
                                    <option value="{{ value }}"
                                            {% if label == request.GET.date_signature %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    {% endif %}

                    {# Champs nature des logements #}
                    <div class="fr-col-12 fr-col-lg-3 search-select">
                        <label class="select-label" for="nature_logement">Nature des logements</label>
                        <select class="fr-select fr-mt-1w" name="nature_logement" id="nature_logement">
                            <option value="">Sélectionner une option</option>
                            {% for value, label in nature_logement_choices %}
                                <option value="{{ value }}"
                                        {% if value == request.GET.nature_logement %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                </div>

                <div class="fr-grid-row fr-grid-row--gutters">

                    {# Champs avenant #}
                    <div class="fr-col-12 fr-col-md-12 fr-col-lg-4">
                        <div class="fr-fieldset__element">
                            <div class="fr-checkbox-group fr-checkbox-group--sm">
                                <input name="avenant_seulement" id="checkbox-restrict-to-with-avenant" type="checkbox" {% if request.GET.avenant_seulement %}checked{% endif %}>
                                <label class="fr-label" for="checkbox-restrict-to-with-avenant">
                                    Afficher uniquement les avenants
                                </label>
                            </div>
                        </div>
                    </div>

                    {# Champs ANRU #}
                    <div class="fr-col-12 fr-col-md-12 fr-col-lg-5">
                        <div class="fr-fieldset__element">
                            <div class="fr-checkbox-group fr-checkbox-group--sm">
                                <input name="anru" id="checkbox-restrict-to-anru" type="checkbox" {% if request.GET.anru %}checked{% endif %}>
                                <label class="fr-label" for="checkbox-restrict-to-anru">
                                    Afficher uniquement les conventions ANRU
                                </label>
                            </div>
                        </div>
                    </div>

                    {# Champs ANAH #}
                    <div class="fr-col-12 fr-col-md-12 fr-col-lg-5">
                        <div class="fr-fieldset__element">
                            <div class="fr-checkbox-group fr-checkbox-group--sm fr-ml-0">
                                <input name="anah" id="checkbox-restrict-to-anah" type="checkbox" {% if request.GET.anah %}checked{% endif %}>
                                <label class="fr-label" for="checkbox-restrict-to-anah">
                                    Afficher uniquement les conventions ANAH
                                </label>
                            </div>
                        </div>
                    </div>


                    <div class="fr-col-12 fr-grid-row fr-grid-row--right">
                        <button class="fr-btn" id="search_btn">
                            <span class="fr-icon-search-line fr-mr-1w" aria-hidden="true"></span>
                            Rechercher
                        </button>
                    </div>

                </div>

            </form>
        </div>
    </div>
</div>
