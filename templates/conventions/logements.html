{% extends "layout/base.html" %}

{% block content %}
    <div class="fr-container-fluid ds_banner fr-pb-1w">
        <div class="fr-container">
            <form method="post" action="" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="fr-grid-row fr-grid-row--gutters">
                    <div class="fr-col-md-12 fr-col-lg-10 fr-col-offset-lg-1 fr-my-5w">
                        <h2>Etape {{convention_form_step}}/{{ nb_steps }} - Détails des logements</h2>
                        {% include "common/convention_edit_info.html" with convention=convention %}
                        {% include "common/mandatory_fields_info.html" %}

                        {% include "common/form/download_upload_form.html" with convention_uuid=convention.uuid file_type='logements' upform=upform  what='logements'%}

                        <hr class="fr-col-12 fr-my-3w">

                        {% for error in import_warnings %}
                            <p id="text-input-error-desc-error" class="fr-error-text">
                                {{ error }}
                            </p>
                        {% endfor %}

                        {% for error in formset.non_form_errors %}
                            <p id="text-input-error-desc-error" class="fr-error-text">
                                {{ error }}
                            </p>
                        {% endfor %}

                        {{ formset.management_form }}
                        <div class="fr-table fr-table--bordered">
                            <table id="lgts_table">
                                <caption>Liste des logements associés à la convention</caption>

                                <thead>
                                    <tr>
                                        <th scope="col" style='min-width:200px;'>Désignation {% if formset.total_form_count %}{% include "common/mandatory_field.html" %}{% endif %}</th>
                                        <th scope="col" style='min-width:150px;'>Type {% if formset.total_form_count %}{% include "common/mandatory_field.html" %}{% endif %}</th>
                                        <th scope="col" style='min-width:120px;'>Surface habitable {% if formset.total_form_count %}{% include "common/mandatory_field.html" %}{% endif %}</th>
                                        <th scope="col" style='min-width:120px;'>Surface des annexes réelle {% if formset.total_form_count %}{% include "common/mandatory_field.html" %}{% endif %}</th>
                                        <th scope="col" style='min-width:120px;'>Surface des annexes retenue dans la SU {% if formset.total_form_count %}{% include "common/mandatory_field.html" %}{% endif %}</th>
                                        <th scope="col" style='min-width:120px;'>Surface Utile {% if formset.total_form_count %}{% include "common/mandatory_field.html" %}{% endif %}</th>
                                        <th scope="col" style='min-width:120px;'>Loyer maxinum en € par m² de surface utile {% if formset.total_form_count %}{% include "common/mandatory_field.html" %}{% endif %}</th>
                                        <th scope="col" style='min-width:120px;'>Coefficient propre au logement {% if formset.total_form_count %}{% include "common/mandatory_field.html" %}{% endif %}</th>
                                        <th scope="col" style='min-width:120px;'>Loyer maxinum du logement en € {% if formset.total_form_count %}{% include "common/mandatory_field.html" %}{% endif %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for form in formset %}
                                        <tr>
                                            <td>
                                                <input
                                                    type="hidden"
                                                    id="{{form.uuid.id_for_label}}"
                                                    name="{{form.uuid.html_name}}"
                                                    value="{{ form.uuid.value|default_if_none:'' }}">
                                                {% include "common/form/input_text.html" with form_input=form.designation %}
                                            </td>
                                            <td>
                                                <select
                                                    class="fr-select {% if form.typologie.errors %}fr-select--error{% endif %}"
                                                    id="{{form.typologie.id_for_label}}"
                                                    name="{{form.typologie.html_name}}">
                                                    <option value="" {% if not form.typologie.value %}selected{% endif %} disabled hidden></option>
                                                    {% for typologie in typologies %}
                                                        <option value="{{typologie.value}}"
                                                            {% if typologie.value  == form.typologie.value %}selected{% endif %}>
                                                            {{typologie.label}}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                                {% for error in form.typologie.errors %}
                                                    <p id="select-error-desc-error" class="fr-error-text">
                                                        {{ error }}
                                                    </p>
                                                {% endfor %}
                                            </td>
                                            <td id="lgt_sh">
                                                {% include "common/form/input_number.html" with form_input=form.surface_habitable step="0.01" onchange="compute_total_value('sh')" %}
                                            </td>
                                            <td id="lgt_sa">
                                                {% include "common/form/input_number.html" with form_input=form.surface_annexes step="0.01" onchange="compute_total_value('sa')" %}
                                            </td>
                                            <td id="lgt_sar">
                                                {% include "common/form/input_number.html" with form_input=form.surface_annexes_retenue step="0.01" onchange="compute_total_value('sar')" %}
                                            </td>
                                            <td id="lgt_su">
                                                {% include "common/form/input_number.html" with form_input=form.surface_utile step="0.01" onchange="compute_total_value('su')" %}
                                            </td>
                                            <td>
                                                {% include "common/form/input_number.html" with form_input=form.loyer_par_metre_carre step="0.01" %}
                                            </td>
                                            <td>
                                                {% include "common/form/input_number.html" with form_input=form.coeficient step="0.001" %}
                                            </td>
                                            <td id="lgt_loyer">
                                                {% include "common/form/input_number.html" with form_input=form.loyer step="0.01" onchange="compute_total_value('loyer')" %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    <tr>
                                        <td class="fr-text--lg">
                                            Total
                                        </td>
                                        <td>
                                        </td>
                                        <td id="total_sh" class="fr-text--lg" style="text-align: center;">
                                        </td>
                                        <td id="total_sa" class="fr-text--lg" style="text-align: center;">
                                        </td>
                                        <td id="total_sar" class="fr-text--lg" style="text-align: center;">
                                        </td>
                                        <td id="total_su" class="fr-text--lg" style="text-align: center;">
                                        </td>
                                        <td>
                                        </td>
                                        <td>
                                        </td>
                                        <td id="total_loyer" class="fr-text--lg" style="text-align: center;">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="fr-col-md-12 fr-col-lg-10 fr-col-offset-lg-1 fr-py-5w" style="display: flex;flex-direction: row;align-items: center;justify-content: space-between;">
                    {% include "common/button/precedent.html" with precedent='conventions:prets' convention_uuid=convention.uuid %}
                    {% include "common/button/suivant.html" with suivant='conventions:logements' convention_uuid=convention.uuid %}
                </div>
            </form>
        </div>
    </div>
    <script  type="text/javascript">
        function compute_total_value(what){
            elements = document.querySelectorAll('[id=lgt_' + what + ']');
            total_value = 0;
            for ( i =0, len = elements.length; i<len; i++) {
                total_value = total_value + parseFloat(elements[i].getElementsByTagName('input')[0].value);
            }
            document.getElementById('total_' + what).innerHTML = "<span>" + total_value.toFixed(2).replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g, " ") + "</span>";
        }
        compute_total_value('sh')
        compute_total_value('sa')
        compute_total_value('sar')
        compute_total_value('su')
        compute_total_value('loyer')
    </script>
{% endblock %}
