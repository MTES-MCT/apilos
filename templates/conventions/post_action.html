{% extends "layout/base.html" %}

{% block page_title %} Actions - APiLos {% endblock%}

{% load static %}

{% block content %}
    <div class="fr-container-fluid ds_banner">
        {% include "conventions/common/form_header.html"%}
        {% include "common/nav_bar.html" with nav_bar_step="action" %}
        <div class="fr-container fr-py-5w">
            <div class="fr-col-12 fr-mt-2w fr-mb-4w">
                <p class="fr-alert__title">
                    Historique
                </p>
                <div class="fr-grid-row">
                    <div class="apilos-step-post-action fr-mr-2w">
                        <div class="apilos-step-post-action--bubble fr-mr-2w"></div>
                        {% if total_avenants > 0 %}
                            <div class="apilos-step-post-action--line"></div>
                        {% endif %}
                    </div>
                    <div class="fr-col-11">
                        {% if convention.televersement_convention_signee_le %}
                            <div class="fr-grid-row">Convention signée le <span class="fr-ml-1v"><strong>{{convention.televersement_convention_signee_le|date:"d F Y"|default_if_none:'-'}}</strong></span></div>
                        {% else %}
                            <div class="fr-grid-row">Votre convention signée a déjà été téléversée</div>
                        {% endif %}
                        <div class="fr-mb-3w">
                            <a class="fr-link" href="{% url 'conventions:preview' convention_uuid=convention.uuid %}"> Voir en PDF</a>
                        </div>
                    </div>
                </div>
                {% include "conventions/avenant_list.html" with conventions=avenants %}
            </div>
            <div class="fr-col-12 fr-mb-4w">
                <div role="alert" class="fr-alert fr-alert--info  fr-icon-arrow-right-s-line-double">
                    <p class="fr-alert__title">
                        Créer un avenant
                    </p>
                    <p>Votre projet a évolué. Vous avez identifié des informations erronées ou caduques ?</p>
                    <div class="block--row-strech">
                        {% if convention|display_create_avenant %}
                            <a class="fr-btn fr-my-1w fr-mr-2w" href="{% url 'conventions:new_avenant' convention_uuid=convention.uuid %}">
                                <span class="fr-icon-add-circle-line fr-mr-1w" aria-hidden="true"></span>Créer un avenant
                            </a>
                        {% else %}
                            <button class="fr-btn fr-my-1w fr-mr-2w" disabled>
                                <span class="fr-icon-add-circle-line fr-mr-1w" aria-hidden="true"></span>Un avenant est déjà en cours.
                            </button>
                        {% endif %}
                        <a class="fr-my-1w fr-link" href="{% url 'conventions:recapitulatif' convention_uuid=convention.uuid %}">
                            Consulter le récapitulatif
                        </a>
                    </div>
                </div>
            </div>
            <hr>
            <div class="fr-col-12">
                <div class="fr-mb-2w fr-pt-2w block--row-strech">
                    <div class="block--row-strech-1 fr-my-2w">
                        <p class="fr-alert__title">
                            Générer la fiche CAF
                        </p>
                        <p class="fr-mb-0">
                            La fiche CAF sera générée en format docx et téléchargée automatiquement.
                        </p>
                    </div>
                    <form action="{% url 'conventions:fiche_caf' convention_uuid=convention.uuid %}">
                        {% csrf_token %}
                        <button class="fr-btn fr-my-1w fr-btn--secondary fr-my-1w fr-icon-download-line fr-btn--icon-left">
                            Générer la fiche CAF
                        </button>
                    </form>
                </div>
            </div>
            {% if request|is_instructeur %}
                <hr>
                <div class="fr-col-12">
                    <div class="fr-mb-2w fr-pt-2w block--row-strech">
                        <div class="block--row-strech-1 fr-my-2w">
                            <p class="fr-alert__title">
                                Téléverser à nouveau la convention
                            </p>
                            <p class="fr-mb-0">
                                Si nécessaire, vous pouvez téléverser une nouvelle version de la convention signée ici.
                            </p>
                        </div>
                        <form method="post" action="{% url 'conventions:sent' convention_uuid=convention.uuid %}" enctype="multipart/form-data" id="{{upform.file.id_for_label}}_form">
                            {% csrf_token %}
                            <input
                                class="fileinput--hidden"
                                type="file"
                                id="{{upform.file.id_for_label}}"
                                name="{{upform.file.html_name}}"
                                accept="application/pdf">
                            <div class="block--row-strech">
                                <div>
                                    <button id="{{upform.file.id_for_label}}_upload_button" class="fr-icon-upload-line fr-btn--icon-left fr-btn fr-my-1w fr-btn--secondary fr-my-1w" type="button">
                                        Téléverser la convention signée
                                    </button>
                                    {% for error in upform.file.errors %}
                                        <p id="text-input-error-desc-error" class="fr-error-text">
                                            {{ error }}
                                        </p>
                                    {% endfor %}
                                </div>
                            </div>

                            <script type="text/javascript" nonce="{{request.csp_nonce}}">
                                document.getElementById('{{upform.file.id_for_label}}_upload_button').onclick = function() {
                                    document.getElementById('{{upform.file.id_for_label}}').click();
                                };
                                document.getElementById('{{upform.file.id_for_label}}').onchange = function() {
                                    var input = document.createElement('input');
                                    input.setAttribute('type', 'hidden');//hidden input
                                    input.setAttribute('name', 'Upload');//set the param name
                                    input.setAttribute('value', 'True');//set the value
                                    this.form.appendChild(input)
                                    document.getElementById("{{upform.file.id_for_label}}_form").submit();
                                }
                            </script>
                        </form>
                    </div>
                </div>
                <hr>
                <div class="fr-col-12">
                    <div class="fr-mb-2w">
                        <p class="fr-alert__title">
                            Date de signature
                        </p>
                        <div class="fr-col-12 fr-my-2w block--row-strech">
                            <div class="block--row-strech-1 fr-mr-6w">

                                <p>
                                    Votre convention a été signée le {{convention.televersement_convention_signee_le|date:"d F Y"|default_if_none:'-'}}.
                                </p>
                                <p>
                                    Ce n'est pas la bonne date ? Vous pouvez la mettre à jour.
                                </p>
                            </div>
                            <details>
                                <summary>
                                    <div class="fr-btn fr-my-1w fr-btn--secondary fr-my-1w">Mettre à jour la date de signature</div>
                                </summary>
                                {% include "conventions/actions/update_date_signature.html" %}
                                <div>Mettre à jour la date</div>

                            </details>
                        </div>
                    </div>
                </div>
            {% endif %}
            {% if convention|display_back_to_instruction:request %}
                <hr>
                <div class="fr-col-12">
                    <div class="fr-mb-2w fr-pt-2w block--row-strech">
                        {% include "conventions/actions/back_to_instruction.html" %}
                    </div>
                </div>
            {% endif %}
            <div class="fr-col-12">
                {% if request|is_instructeur %}
                    <hr>
                    <div class="fr-mb-5w fr-pt-2w">
                        <div class="fr-my-2w">
                            <p class="fr-alert__title">
                                Résiliation/dénonciation de la convention
                            </p>
                            <p class="fr-mb-2w">Vous pouvez ici procéder à la résiliation/dénonciation de la convention dans APiLos.</p>

                            <form method="post" action="" id="{{resiliation_form.date_resiliation.id_for_label}}_validation_form">
                                {% csrf_token %}
                                <div class="block--row-strech">
                                    <div class="block--row-strech-1  fr-mr-6w">

                                        {% include "common/form/input_date.html" with form_input=resiliation_form.date_resiliation editable=True %}
                                    </div>

                                    <button class="fr-btn apilos-btn--secondary--red fr-btn--icon-left fr-icon-delete-line fr-my-2w" data-fr-opened="false" type="button" aria-controls="fr-modal-resiliate-{{convention.uuid}}">
                                        Résilier/Dénoncer la convention
                                    </button>
                                </div>
                            </form>
                        </div>
                        <dialog aria-labelledby="fr-modal-resiliate-{{convention.uuid}}-title" id="fr-modal-resiliate-{{convention.uuid}}" class="fr-modal" role="dialog">
                            <div class="fr-container fr-container--fluid fr-container-md">
                                <div class="fr-grid-row fr-grid-row--center">
                                    <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                                        <div class="fr-modal__body">
                                            <div class="fr-modal__header">
                                                <button class="fr-link--close fr-link" aria-controls="fr-modal-resiliate-{{convention.uuid}}">Fermer</button>
                                            </div>
                                            <div class="fr-modal__content">
                                                <h1 id="fr-modal-resiliate-{{convention.uuid}}-title" class="fr-modal__title">
                                                    <span class="fr-icon-arrow-right-line fr-icon--lg"></span>
                                                    {{ convention }}
                                                </h1>
                                                <p>Vous vous apprétez à résilier/dénoncer la convention "{{convention}}", êtes-vous sûr ?</p>
                                            </div>
                                            <div class="fr-modal__footer">
                                                <ul class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg fr-btns-group--icon-left">
                                                    <li>
                                                        <button type="button" class="fr-btn fr-btn--icon-left fr-icon-delete-line" id='resiliate_{{convention.uuid}}'>
                                                            Résilier/dénoncer la convention
                                                        </button>
                                                        <script type="text/javascript" nonce="{{request.csp_nonce}}">
                                                            document.getElementById('resiliate_{{convention.uuid}}').addEventListener('click', function(){
                                                                document.getElementById('{{resiliation_form.date_resiliation.id_for_label}}_validation_form').submit();
                                                            });
                                                        </script>
                                                    </li>
                                                    <li>
                                                        <button type="button" class="fr-btn fr-btn--secondary" aria-controls="fr-modal-resiliate-{{convention.uuid}}">Annuler</button>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </dialog>
                    </div>
                {% endif %}
            </div>
        </div>
{% endblock %}
