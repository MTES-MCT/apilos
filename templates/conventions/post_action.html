{% extends "layout/base.html" %}

{% block page_title %} Actions - APiLos {% endblock%}

{% load static %}

{% block content %}
    <div class="fr-container-fluid ds_banner">
        {% include "conventions/common/form_header.html"%}
        {% include "common/step_progressbar.html"%}
        <div class="fr-container fr-pb-5w">
            {% if convention.televersement_convention_signee_le %}
                <p class="fr-h3">Votre convention signée a été téléversée le {{convention.televersement_convention_signee_le}}
                </p>
            {% else %}
                <p class="fr-h3">Votre convention signée a déjà été téléversée</p>
            {% endif %}
            {% if request|is_bailleur %}
                <div class="fr-col-md-12">
                    <div role="alert" class="fr-alert fr-alert--info">
                        <p class="fr-alert__title">
                            Avenants
                        </p>
                        <p>
                            L'avenant créé sera automatiquement rattaché à la convention actuelle.
                        </p>
                        <div>
                            <a class="fr-btn fr-my-1w" href="{% url 'conventions:new_avenant' convention_uuid=convention.uuid %}">
                                <span class="fr-fi-add-circle-line fr-mr-1w" aria-hidden="true"></span>Créer un avenant
                            </a>
                        </div>
                    </div>
                </div>
            {% endif %}
            <div class="fr-grid-row fr-grid-row--gutters">
                <div class="fr-col-12 fr-mb-2w block--row-strech apilos-line-top">
                    <div class="block--row-strech-1 fr-my-2w">
                        <p class="fr-alert__title">
                            Générer la fiche CAF
                        </p>
                        <p>
                            La fiche CAF sera générée en format docx et téléchargée automatiquement.
                        </p>
                    </div>
                    <form action="{% url 'conventions:fiche_caf' convention_uuid=convention.uuid %}">
                        {% csrf_token %}
                        <button class="fr-btn fr-my-1w fr-btn--secondary fr-my-1w fr-icon-download-line fr-btn--icon-left">
                            Générer la fiche CAF
                        </button>
                    </form>
                </div>
            </div>
            <div class="fr-grid-row fr-grid-row--gutters">
                <div class="fr-col-12 fr-mb-2w block--row-strech apilos-line-top">
                    <div class="block--row-strech-1 fr-my-2w">
                        <p class="fr-alert__title">
                            Voir la conventions signée (en PDF)
                        </p>
                        <p>
                            Vous pouvez la prévisualiser et la télécharger.
                        </p>
                    </div>
                    <button class="fr-btn fr-btn--secondary fr-my-1w fr-icon-eye-line fr-btn--icon-left">
                        <a href="{% url 'conventions:preview' convention_uuid=convention.uuid %}">Consulter</a>
                    </button>
                </div>
            </div>
            <div class="fr-grid-row fr-grid-row--gutters">
                {% if request|is_instructeur %}
                    <div class="fr-col-12  fr-mb-3w">
                        <div role="alert" class="fr-alert fr-alert--warning">
                            <p class="fr-alert__title">
                                Résiliation/dénonciation de la convention
                            </p>
                            <p class="fr-mb-2w">Vous pouvez ici procéder à la résiliation/dénonciation de la convention dans APiLos.</p>
                            <form method="post" action="" id="{{resiliation_form.date_resiliation.id_for_label}}_validation_form">
                                {% csrf_token %}
                                {% include "common/form/input_date.html" with form_input=resiliation_form.date_resiliation editable=True %}

                                <button class="fr-btn apilos-btn--red fr-btn--icon-left fr-fi-delete-line fr-my-2w" data-fr-opened="false" type="button" aria-controls="fr-modal-resiliate-{{convention.uuid}}">
                                    Résilier/Dénoncer la convention
                                </button>
                            </form>
                        </div>
                        <dialog aria-labelledby="fr-modal-resiliate-{{convention.uuid}}-title" id="fr-modal-resiliate-{{convention.uuid}}" class="fr-modal" role="dialog">
                            <div class="fr-container fr-container--fluid fr-container-md">
                                <div class="fr-grid-row fr-grid-row--center">
                                    <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                                        <div class="fr-modal__body">
                                            <div class="fr-modal__header">
                                                <button class="fr-link--close fr-link" aria-controls="fr-modal-resiliate-{{convention.uuid}}">Fermer</button>
                                            </div>
                                            <div class="fr-modal__content">
                                                <h1 id="fr-modal-resiliate-{{convention.uuid}}-title" class="fr-modal__title">
                                                    <span class="fr-fi-arrow-right-line fr-fi--lg"></span>
                                                    {{ convention }}
                                                </h1>
                                                <p>Vous vous apprétez à résilier/dénoncer la convention "{{convention}}", êtes-vous sûr ?</p>
                                            </div>
                                            <div class="fr-modal__footer">
                                                <ul class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg fr-btns-group--icon-left">
                                                    <li>
                                                        <button type="button" class="fr-btn fr-btn--icon-left fr-fi-delete-line" id='resiliate_{{convention.uuid}}'>
                                                            Résilier/dénoncer la convention
                                                        </button>
                                                        <script type="text/javascript" nonce="{{request.csp_nonce}}">
                                                            document.getElementById('resiliate_{{convention.uuid}}').addEventListener('click', function(){
                                                                document.getElementById('{{resiliation_form.date_resiliation.id_for_label}}_validation_form').submit();
                                                            });
                                                        </script>
                                                    </li>
                                                    <li>
                                                        <button type="button" class="fr-btn fr-btn--secondary" aria-controls="fr-modal-resiliate-{{convention.uuid}}">Annuler</button>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </dialog>
                    </div>
                {% endif %}
            </div>
            <div class="apilos-line-top"></div>
            {% include "conventions/avenant_list.html" with conventions=avenants %}

            {% if request|is_instructeur %}
                <div class="fr-accordion fr-mt-5w">
                    <div class="fr-accordion__title">
                        <div class="fr-accordion__btn clickable " aria-expanded="false" aria-controls="accordion-106"><em>Si nécessaire, vous pouvez téléverser une nouvelle version de la convention signée ici.</em></div>
                    </div>
                    <div class="fr-collapse" id="accordion-106">

                        <form method="post" action="{% url 'conventions:sent' convention_uuid=convention.uuid %}" enctype="multipart/form-data" id="{{upform.file.id_for_label}}_form">
                            {% csrf_token %}
                            <input
                                class="fileinput--hidden"
                                type="file"
                                id="{{upform.file.id_for_label}}"
                                name="{{upform.file.html_name}}"
                                accept="application/pdf">
                            <div class="block--row-strech">
                                <div>
                                    <button id="{{upform.file.id_for_label}}_upload_button" class="fr-btn fr-icon-upload-line fr-btn--icon-left" type="button">
                                        Téléverser la convention signée
                                    </button>
                                    {% for error in upform.file.errors %}
                                        <p id="text-input-error-desc-error" class="fr-error-text">
                                            {{ error }}
                                        </p>
                                    {% endfor %}
                                </div>
                            </div>

                            <script type="text/javascript" nonce="{{request.csp_nonce}}">
                                document.getElementById('{{upform.file.id_for_label}}_upload_button').onclick = function() {
                                    document.getElementById('{{upform.file.id_for_label}}').click();
                                };
                                document.getElementById('{{upform.file.id_for_label}}').onchange = function() {
                                    var input = document.createElement('input');
                                    input.setAttribute('type', 'hidden');//hidden input
                                    input.setAttribute('name', 'Upload');//set the param name
                                    input.setAttribute('value', 'True');//set the value
                                    this.form.appendChild(input)
                                    document.getElementById("{{upform.file.id_for_label}}_form").submit();
                                }
                            </script>
                        </form>
                    </div>
                </div>
            {% endif %}
        </div>
{% endblock %}
