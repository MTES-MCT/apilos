{% extends "layout/base.html" %}

{% block page_title %}Bailleur - APiLos{% endblock%}
{% block javascript_extras %}
    <script>
        function create_comment(input_id, object_field) {
            var [object_name, object_field] = object_field.split('__')
            comment = document.getElementById(input_id+ '_comment-textarea').value
            csrf_token = document.getElementsByName('csrfmiddlewaretoken')[0].value

            var headers = {
                'X-CSRFToken': csrf_token,
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }

            fetch('/comments/', {
                method: 'post',
                headers: headers,
                body: JSON.stringify({
                    comment: comment,
                    object : object_name,
                    field : object_field,
                    convention_uuid : '{{convention.uuid}}'
                })
            }).then(function(response) {
                if (response.status == 200) {
                    res = response.json()
                    return res;
                }
            }).then(res => {
                create_comment_input(input_id, res.comment)
                console.log(res)
            });

            // Close the dialogbox
            //document.getElementById(input_id + '_comment-img').setAttribute('data-fr-opened',false)
        }

        function create_comment_input(input_id, comment) {
            var before_id = input_id + "_new_comment"
            var comment_modal_id = input_id + "_modal_comment"
            new_comment_block = document.getElementById(before_id)
            new_comment_block.hidden = true
            const owner_div = create_comment_owner(comment.username, comment.is_owner);
            document.getElementById(comment_modal_id).insertBefore( owner_div, new_comment_block );
            const date_div = create_comment_date(comment.mis_a_jour_le);
            document.getElementById(comment_modal_id).insertBefore( date_div, new_comment_block );
            const uuid_div = create_comment_uuid(comment.uuid);
            document.getElementById(comment_modal_id).insertBefore( uuid_div, new_comment_block );
            const textarea_div = create_comment_textarea(comment.uuid, comment.message);
            document.getElementById(comment_modal_id).insertBefore( textarea_div, new_comment_block );
            const ul_buttons = create_comment_button(comment.uuid)
            document.getElementById(comment_modal_id).insertBefore( ul_buttons, new_comment_block );
            init_comment_button(comment.uuid, comment.statut, comment.is_owner, '{{request.user.is_instructeur}}')
        }

        //<div class="fr-mt-3w"><b>Raphaëlle Neyton (vous) :</b></div>
        function create_comment_owner(username, is_owner) {
            const owner_div = document.createElement('div');
            owner_div.classList.add('fr-mt-3w')
            owner_div.classList.add('text-bold')
            inner_text = username
            if (is_owner && is_owner != 'False') {
                inner_text = inner_text + " (vous)"
            }
            owner_div.innerText = inner_text + " :"
            return owner_div
        }

        //<div class="fr-text-sm text-italic"><i>le 3 novembre 2021 12:06</i></div>
        function create_comment_date(date) {
            const date_div = document.createElement('div');
            date_div.classList.add('fr-text-sm')
            date_div.classList.add('text-italic')
            date_div.innerText = "le " + date
            return date_div
        }

        //<input type="hidden" value="fb7d6bf9-291a-4b3d-b2a6-25fea7e20dcb">
        function create_comment_uuid(uuid) {
            const uuid_div = document.createElement('input');
            uuid_div.setAttribute('type', "hidden")
            uuid_div.value = uuid
            return uuid_div
        }

        //<textarea class="fr-input" aria-describedby="text-input-error-desc-error" type="text" id="comment_fb7d6bf9-291a-4b3d-b2a6-25fea7e20dcb" rows="5">tt</textarea>
        function create_comment_textarea(uuid, message) {
            const textarea_div = document.createElement('textarea');
            textarea_div.classList.add('fr-input')
            textarea_div.setAttribute('aria-describedby', "text-input-error-desc-error")
            textarea_div.setAttribute('type', "text")
            textarea_div.setAttribute('id', "comment_" + uuid)
            textarea_div.setAttribute('rows', "5")
            textarea_div.innerText = message
            return textarea_div
        }

        // <ul class="fr-mt-1w fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg fr-btns-group--icon-left fr-btns-group--sm">
        //     <li id="block_comment_close_96c201c0-c0ce-4400-9b73-09803961e6a1" class="button-hidden">
        //         <button id="comment_close_96c201c0-c0ce-4400-9b73-09803961e6a1" type="button" class="fr-btn fr-btn--sm fr-btn--grey">
        //             Marquer comme clos
        //         </button>
        //     </li>
        //     <li id="block_comment_resolve_96c201c0-c0ce-4400-9b73-09803961e6a1">
        //         <button id="comment_resolve_96c201c0-c0ce-4400-9b73-09803961e6a1" type="button" class="fr-btn fr-btn--sm fr-btn--green">
        //             Marquer comme résolu
        //         </button>
        //     </li>
        //     <li id="block_comment_reopen_96c201c0-c0ce-4400-9b73-09803961e6a1" class="button-hidden">
        //         <button id="comment_reopen_96c201c0-c0ce-4400-9b73-09803961e6a1" type="button" class="fr-btn fr-btn--sm">
        //             Ré-ouvrir
        //         </button>
        //     </li>
        //     <li id="block_comment_save_96c201c0-c0ce-4400-9b73-09803961e6a1">
        //         <button id="comment_save_96c201c0-c0ce-4400-9b73-09803961e6a1" type="button" class="fr-btn fr-btn--sm">
        //             Enregistrer
        //         </button>
        //     </li>
        // </ul>

        function create_comment_button(uuid) {
            const ul_buttons = document.createElement('ul')
            ul_buttons.classList.add('fr-mt-1w', 'fr-btns-group', 'fr-btns-group--right', 'fr-btns-group--inline-reverse', 'fr-btns-group--inline-lg', 'fr-btns-group--icon-left', 'fr-btns-group--sm')
            ul_buttons.appendChild(create_li_button(uuid, 'close', 'Marquer comme clos', 'fr-btn--grey'))
            ul_buttons.appendChild(create_li_button(uuid, 'resolve', 'Marquer comme résolu', 'fr-btn--green'))
            ul_buttons.appendChild(create_li_button(uuid, 'reopen', 'Ré-ouvrir'))
            ul_buttons.appendChild(create_li_button(uuid, 'save', 'Enregistrer'))
            return ul_buttons
        }

        function create_li_button(uuid, action, label, additionalButtonClass=null) {
            const button_action = document.createElement('button')
            button_action.setAttribute('id', 'comment_' + action + '_' + uuid)
            button_action.setAttribute('type', 'button')
            button_action.classList.add('fr-btn', 'fr-btn--sm')
            if (additionalButtonClass != null) {
                button_action.classList.add(additionalButtonClass)
            }
            button_action.innerText = label
            const li_action = document.createElement('li')
            li_action.setAttribute('id', 'block_comment_' + action + '_' + uuid)
            //            li_action.classList.add('button-hidden')
            li_action.appendChild(button_action)
            return li_action
        }

        function save_comment(uuid) {
            message = document.getElementById("comment_" + uuid).value
            csrf_token = document.getElementsByName('csrfmiddlewaretoken')[0].value

            var headers = {
                'X-CSRFToken': csrf_token,
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }

            fetch('/comments/' + uuid, {
                method: 'post',
                headers: headers,
                body: JSON.stringify({
                    message: message
                })
            }).then(function(response) {
                if (response.status == 200) {
                    return response.json();
                }
            }).then(res => console.log(res));

        }

        function init_comment_button(uuid, comment_statut, is_owner, is_instructeur) {
            console.log(uuid)
            console.log(comment_statut)
            console.log(is_owner)
            console.log(is_instructeur)
            // button 'Marquer comme clos'
            if (is_instructeur == 'True' && comment_statut != 'CLOS') {
                document.getElementById('block_comment_close_' + uuid).classList.remove('button-hidden')
            }
            else {
                document.getElementById('block_comment_close_' + uuid).classList.add('button-hidden')
            }
            document.getElementById('comment_close_' + uuid).onclick = function() {
                alert('CLOS ' + uuid)
            }

            // button 'Marquer comme résolu'
            if (comment_statut == 'OUVERT') {
                document.getElementById('block_comment_resolve_' + uuid).classList.remove('button-hidden')
            }
            else {
                document.getElementById('block_comment_resolve_' + uuid).classList.add('button-hidden')
            }
            document.getElementById('comment_resolve_' + uuid).onclick = function() {
                alert('RESOLU ' + uuid)
            }

            // button 'Ré-ouvrir'
            if (comment_statut == 'RESOLU') {
                document.getElementById('block_comment_reopen_' + uuid).classList.remove('button-hidden')
            }
            else {
                document.getElementById('block_comment_reopen_' + uuid).classList.add('button-hidden')
            }
            document.getElementById('comment_reopen_' + uuid).onclick = function() {
                alert('REOPEN ' + uuid)
            }

            // button 'Enregistrer'
            if (comment_statut == 'OUVERT' && (is_owner && is_owner != 'False')) {
                document.getElementById('block_comment_save_' + uuid).classList.remove('button-hidden')
            }
            else {
                document.getElementById('block_comment_save_' + uuid).classList.add('button-hidden')
            }
            document.getElementById('comment_save_' + uuid).onclick = function() {
                save_comment(uuid)
            }
        }

    </script>
{% endblock %}

{% block content %}
    <div class="fr-container-fluid ds_banner">
        <div class="fr-container">
            <form method="post" action="">
                {% csrf_token %}
                <div class="fr-grid-row fr-grid-row--gutters">
                    <div class="fr-col-12 fr-col-md-12  fr-my-5w">
                        {% include "common/convention_edit_info.html" with convention=convention %}
                        <h2>Etape {{convention_form_step}}/{{ nb_steps }} - Identité du signataire</h2>
                        {% include "common/mandatory_fields_info.html" %}

                        <h4>Entreprise bailleur</h4>

                        {% include "common/form/input_text.html" with form_input=form.nom label="Nom du bailleur" object_field="programme__nom" %}
                        <div class="fr-mb-2w">
                            <div class="fr-grid-row fr-grid-row--gutters">
                                <div class="fr-col-12 fr-col-md-12 fr-col-lg-6 fr-mb-2w">
                                    {% include "common/form/input_text.html" with form_input=form.siret label="SIRET ou SIREN" object_field="programme__siret" %}
                                </div>
                                <div class="fr-col-12 fr-col-md-12 fr-col-lg-6 fr-pl-md-1w fr-mb-2w">
                                    {% include "common/form/input_number.html" with step="0.01" form_input=form.capital_social label="Capital social" mandatory=False %}
                                </div>
                            </div>
                        </div>

                        {% include "common/form/input_text.html" with form_input=form.adresse label="Adresse" %}

                        <div class="fr-mb-2w">
                            <div class="fr-grid-row fr-grid-row--gutters">
                                <div class="fr-col-12 fr-col-md-12 fr-col-lg-6 fr-mb-2w">
                                    {% include "common/form/input_text.html" with form_input=form.code_postal label="Code postal" %}
                                </div>
                                <div class="fr-col-12 fr-col-md-12 fr-col-lg-6 fr-pl-md-1w fr-mb-2w">
                                    {% include "common/form/input_text.html" with form_input=form.ville label="Ville" %}
                                </div>
                            </div>
                        </div>

                        <h4>Signataire de la convention</h4>

                        {% include "common/form/input_text.html" with form_input=form.dg_nom label="Nom du signataire de la convention" %}

                        <div class="fr-mb-2w">
                            <div class="fr-grid-row fr-grid-row--gutters">
                                <div class="fr-col-12 fr-col-md-12 fr-col-lg-6 fr-mb-2w">
                                    {% include "common/form/input_text.html" with form_input=form.dg_fonction label="Fonction du signataire de la convention" %}
                                </div>
                                <div class="fr-col-12 fr-col-md-12 fr-col-lg-6 fr-pl-md-1w fr-mb-2w">
                                    {% include "common/form/input_date.html" with form_input=form.dg_date_deliberation label="Date de délibération" %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-button-footer fr-col-12 fr-col-md-12  fr-py-5w">
                    {% include "common/button/previous.html" with precedent='conventions:selection_update' convention_uuid=convention.uuid %}
                    {% if editable %}
                        {% include "common/button/next_and_save.html" with suivant='conventions:bailleur' convention_uuid=convention.uuid editable=editable %}
                    {% else %}
                        {% include "common/button/next.html" with suivant='conventions:programme' convention_uuid=convention.uuid %}
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
{% endblock %}
