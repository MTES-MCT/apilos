{% load custom_filters %}

{% if convention %}
    <div class="apilos-sticky fr-container fr-pt-2w {% if convention|display_convention_form_progressbar %}no_navbar{% endif %}">
        <div class="fr-grid-row fr-grid-row--gutters">
            <div class="fr-col-12 fr-py-3w">
                <h1 class="fr-h2 apilos-d-inline">{{convention.programme.nom}}</h1>
                {% if convention.is_avenant %}
                    <span class="apilos-h2-thin"> - Avenant{% if convention.numero %} n°{{ convention.numero }}{% endif %}</span>
                    <div class="fr-py-3w">
                        <a class='fr-link apilos-link' href="{% url 'conventions:post_action' convention_uuid=convention.parent.uuid %}">Consulter la convention originale</a>
                    </div>
                {% else %}
                    <div class="apilos-text--italic">
                        {% if CERBERE_AUTH and convention.programme.numero_galion %}
                            <a href="{% url 'programmes:operation_conventions' numero_operation=convention.programme.numero_galion %}">
                                Opération n°{{convention.programme.numero_galion}}
                            </a>&nbsp;-&nbsp;
                        {% endif %}
                        {{ convention.programme.ville|default_if_none:'-' }}&nbsp;-&nbsp;
                        {{ convention.lot.nb_logements|default_if_none:'-' }}&nbsp;lgts&nbsp;-&nbsp;
                        {{ convention.lot.get_type_habitat_display }}{{ convention.lot.nb_logements|pluralize }}&nbsp;-&nbsp;
                        {{ convention.lot.financement|default_if_none:'' }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div>
        <div class="fr-container fr-pt-2w">
            {% if convention.ecolo_reference %}
                <div class="fr-alert fr-alert--info">
                    <h3 class="fr-alert__title">Issue d'Ecoloweb</h3>
                    <p>Les données de cette convention ont été importées depuis la plateforme Ecoloweb</p>
                </div>
            {% endif %}


            {% if convention.statut == CONVENTION_STATUT.PROJET %}
                <div role="alert" class="fr-col-12 fr-mb-3w fr-alert fr-alert--{{convention.statut_for_template.key_statut}} fr-icon-pencil-line">
                    {% if convention.is_avenant %}
                        <p class="fr-text--lg">
                            Votre avenant est
                            <span class="fr-text--bold">
                                en projet
                            </span>
                        </p>
                        <p>Complétez ses informations, puis soumettez-le à votre service d’instruction</p>
                    {% else %}
                        <p class="fr-text--lg">
                            Votre convention est
                            <span class="fr-text--bold">
                                en projet
                            </span>
                        </p>
                        <p>Complétez ses informations, puis soumettez-la à votre service d’instruction</p>
                    {% endif %}
                </div>
            {% endif %}
            {% if convention.statut == CONVENTION_STATUT.INSTRUCTION %}
                <div role="alert" class="fr-col-12 fr-mb-3w fr-alert fr-alert--{{convention.statut_for_template.key_statut}} fr-icon-eye-line">
                    {% if convention.is_avenant %}
                        <p class="fr-text--lg">
                            Votre avenant est
                            <span class="fr-text--bold">
                                en cours d'instruction
                            </span>
                        </p>
                        <p>Il sera prochainement validé ou votre instructeur vous demandera des corrections</p>
                    {% else %}
                        <p class="fr-text--lg">
                            Votre convention est
                            <span class="fr-text--bold">
                                en cours d'instruction
                            </span>
                        </p>
                        <p>Elle sera prochainement validée ou votre instructeur vous demandera des corrections</p>
                    {% endif %}
                </div>
            {% endif %}
            {% if convention.statut == CONVENTION_STATUT.CORRECTION %}
                <div role="alert" class="fr-col-12 fr-mb-3w fr-alert fr-alert--{{convention.statut_for_template.key_statut}} fr-icon-question-answer-line">
                    {% if convention.is_avenant %}
                        <p class="fr-text--lg">
                            Votre avenant est
                            <span class="fr-text--bold">
                                en attente de corrections
                            </span>
                        </p>
                        <p>Corrigez les demandes de votre instructeur puis soumettez-le à nouveau</p>
                    {% else %}
                        <p class="fr-text--lg">
                            Votre convention est
                            <span class="fr-text--bold">
                                en attente de corrections
                            </span>
                        </p>
                        <p>Corrigez les demandes de votre instructeur puis soumettez-la à nouveau</p>
                    {% endif %}
                </div>
            {% endif %}
            {% if convention.statut == CONVENTION_STATUT.A_SIGNER %}
                <div role="alert" class="fr-col-12 fr-mb-3w fr-alert fr-alert--{{convention.statut_for_template.key_statut}} fr-icon-draft-line">
                    {% if convention.is_avenant %}
                        <p class="fr-text--lg">
                            Votre avenant est
                            <span class="fr-text--bold">
                                en attente d'une signature
                            </span>
                        </p>
                        {% if request|is_instructeur %}
                            Vous pouvez <a class="fr-link" href="{% url 'conventions:sent' convention_uuid=convention.uuid %}" target="_self" {% if nav_bar_step == "sent" %}aria-current="page"{% endif %}>téléverser l'avenant signé</a>
                        {% else %}
                            {% if convention.programme.administration.adresse and convention.programme.administration.code_postal and convention.programme.administration.ville %}
                                <p>Imprimez-le, signez-le et envoyez le à l'adresse suivante : {{ convention.programme.administration.adresse }} - {{ convention.programme.administration.code_postal }} {{ convention.programme.administration.ville }}</p>
                            {% endif %}
                        {% endif %}
                    {% else %}
                        <p class="fr-text--lg">
                            Votre convention est
                            <span class="fr-text--bold">
                                en attente d'une signature
                            </span>
                        </p>
                        {% if request|is_instructeur %}
                            Vous pouvez <a class="fr-link" href="{% url 'conventions:sent' convention_uuid=convention.uuid %}" target="_self" {% if nav_bar_step == "sent" %}aria-current="page"{% endif %}>téléverser la convention signée</a>
                        {% else %}
                            {% if convention.programme.administration.adresse and convention.programme.administration.code_postal and convention.programme.administration.ville %}
                                <p>Imprimez-la, signez-la et envoyez la à l'adresse suivante : {{ convention.programme.administration.adresse }} - {{ convention.programme.administration.code_postal }} {{ convention.programme.administration.ville }}</p>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </div>
            {% endif %}
            {% if convention.statut == CONVENTION_STATUT.SIGNEE %}
                <div role="alert" class="fr-col-12 fr-mb-3w fr-alert fr-alert--{{convention.statut_for_template.key_statut}} fr-icon-success-line">
                    {% if convention.is_avenant %}
                        <p class="fr-text--lg">
                            Votre avenant est
                            <span class="fr-text--bold">
                                finalisé !
                            </span>
                        </p>
                        <p>Vous devrez désormais créer un autre avenant si vous souhaitez mettre à jour une information</p>
                    {% else %}
                        <p class="fr-text--lg">
                            Votre convention est
                            <span class="fr-text--bold">
                                finalisée !
                            </span>
                        </p>
                        <p>Vous devrez désormais créer un avenant si vous souhaitez mettre à jour une information</p>
                    {% endif %}
                </div>
            {% endif %}
            {% if convention.statut == CONVENTION_STATUT.RESILIEE %}
                <div role="alert" class="fr-col-12 fr-mb-3w fr-alert fr-alert--{{convention.statut_for_template.key_statut}} fr-icon-success-line">
                    {% if convention.is_avenant %}
                        <p class="fr-text--lg">
                            Votre avenant est
                            <span class="fr-text--bold">
                                résilié !
                            </span>
                        </p>
                        <p>Il n'est pas possible d'y apporter des modifications</p>
                    {% else %}
                        <p class="fr-text--lg">
                            Votre convention est
                            <span class="fr-text--bold">
                                résiliée !
                            </span>
                        </p>
                        <p>Il n'est pas possible d'y apporter des modifications</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
{% endif %}
