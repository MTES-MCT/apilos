<div class="fr-col-12 fr-col-lg-3 search-select" data-field-id="{{ field_id }}">
    <label class="select-label" for="{{ field_id }}" id="label-{{ field_id }}">
        {{ label }}
    </label>
    <select
        multiple
        class="fr-select fr-mt-1w"
        id="{{ field_id }}"
        name="{{ field_id }}"
        aria-labelledby="label-{{ field_id }}"
        data-selected-values="{{ request_url|join:',' }}">
        {% for choice_label, choice_value in choices %}
            <option value="{{ choice_value }}">
                {{ choice_label }}
            </option>
        {% endfor %}
    </select>
</div>

<script type="text/javascript" nonce="{{ request.csp_nonce }}">
    document.addEventListener('DOMContentLoaded', function() {
        const element = document.querySelector('#{{ field_id }}');

        if (element) {
            // Récupérer les valeurs sélectionnées depuis l'attribut data
            const selectedValuesAttr = element.getAttribute('data-selected-values');
            const selectedValues = selectedValuesAttr ? selectedValuesAttr.split(',').filter(v => v) : [];

            // Marquer les options comme sélectionnées
            if (selectedValues.length > 0) {
                Array.from(element.options).forEach(option => {
                    if (selectedValues.includes(option.value)) {
                        option.selected = true;
                    }
                });
            }

            const choices = new Choices(element, {
                removeItemButton: true,
                searchEnabled: false,
                placeholder: true,
                placeholderValue: 'Sélectionner',
                itemSelectText: '',
                shouldSort: false,
                classNames: {
                    containerOuter: ['choices', 'fr-select', 'fr-mt-1w']
                },
                noResultsText: 'Aucun résultat',
                noChoicesText: 'Aucun choix disponible',
                removeItemIconText: 'Supprimer',
                removeItemLabelText: 'Supprimer l\'élément',
                labelId: 'label-{{ field_id }}'
            });

            const choicesInput = element.closest('.choices').querySelector('.choices__input');
            if (choicesInput) {
                choicesInput.setAttribute('aria-labelledby', 'label-{{ field_id }}');
            }

            choices.passedElement.element.addEventListener('addItem', function() {
                setTimeout(() => {
                    const items = element.closest('.choices').querySelectorAll('.choices__item--selectable');
                    items.forEach(item => {
                        const button = item.querySelector('.choices__button');
                        if (button) {
                            const itemText = item.textContent.replace('Supprimer l\'élément', '').trim();
                            button.setAttribute('aria-label', `Supprimer ${itemText}`);
                        }
                    });
                }, 10);
            });
        }
    });
</script>
